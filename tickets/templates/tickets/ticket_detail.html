{% extends "base.html" %}
{% block title %}Ticket {{ object.id }}{% endblock %}

{% block content %}
<h2>{{ object.title }}</h2>
<p>{{ object.description }}</p>
<p><strong>Statut :</strong> {{ object.get_status_display }}</p>
<p><strong>Client :</strong> {{ object.client }}</p>
<p><strong>App :</strong> {{ object.project }}</p>
<p><strong>Dev assigné :</strong> {{ object.assignee }}</p>
<p><strong>Ouvert par: </strong> {{ object.reporter }} </p>
<p><strong>Niveau de priorité</strong> {{ object.get_priority_display }}</p>
<p><strong>Créé le </strong> {{ object.created_at }}</p>

<hr>

<h3>Chat</h3>
<div class="chat-box border p-3 mb-3 bg-light" style="max-height:400px; overflow-y:auto;">
  {% for comment in object.comments.all %}
    {% if comment.is_system %}
      <!-- Ligne système, centrée -->
      <div class="d-flex justify-content-center mb-2">
        <div class="px-2 py-1 rounded bg-white border text-muted small">
          {{ comment.body|safe }}
          <span class="ms-2 text-secondary">— {{ comment.created_at|date:"d/m/Y H:i" }}</span>
        </div>
      </div>
    {% elif comment.author == request.user %}
      <!-- Bulle à droite (utilisateur courant) -->
      <div class="d-flex justify-content-end mb-2">
        <div class="p-2 rounded bg-primary text-white" style="max-width:70%;">
          <p class="mb-1">{{ comment.body|linebreaks }}</p>
          <small class="text-white-50">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
        </div>
      </div>
    {% else %}
      <!-- Bulle à gauche (autre personne) -->
      <div class="d-flex justify-content-start mb-2">
        <div class="p-2 rounded bg-white border" style="max-width:70%;">
          <strong>{{ comment.author.username }}</strong>
          <p class="mb-1">{{ comment.body|linebreaks }}</p>
          <small class="text-muted">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
        </div>
      </div>
    {% endif %}
  {% empty %}
    <p class="text-muted">Aucun message pour le moment.</p>
  {% endfor %}
</div>


{% if object.status != "CLO" %}
  <form method="post" action="{% url 'tickets:add_comment' object.id %}">
    {% csrf_token %}
    <div class="input-group">
      {{ form.body }}
      <button type="submit" class="btn btn-primary">Envoyer</button>
    </div>
  </form>
{% endif %}


<!-- Bouton retour -->
<a href="{% url 'tickets:ticket_list' %}" class="btn btn-secondary mt-3">← Retour à la liste</a>

<!-- Bouton modifier -->
<a href="{% url 'tickets:ticket_update' object.id %}" class="btn btn-warning mt-3">✏️Modifier</a>

{% if object.status == "OPEN" %}
  <a href="{% url 'tickets:ticket_assign' object.id %}" class="btn btn-warning mt-3">
    👤Assigner
  </a>
{% endif %}


{% if object.status == "WIP" %}
  {% if request.user.is_staff or request.user.is_developer %}
    <form method="post" action="{% url 'tickets:ticket_resolve' object.id %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-success mt-3">
        ✅Marquer comme résolu
      </button>
    </form>
  {% endif %}
{% endif %}



{% if object.status != "CLO" %}
  {% if request.user.is_staff or request.user.is_developer %}
    <form method="post" action="{% url 'tickets:ticket_close' object.id %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger mt-3">
        🔒Clôturer
      </button>
    </form>
  {% endif %}
{% endif %}



{% if object.status == "CLO" %}
  {% if request.user.is_staff or request.user.is_reporter %}
    <form method="post" action="{% url 'tickets:ticket_reopen' object.id %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-success mt-3">
        🔓Réouvrir
      </button>
    </form>
  {% endif %}
{% endif %}

{% if request.user.is_staff or request.user.is_reporter %}
  <a href="{% url 'tickets:ticket_delete' object.pk %}" class="btn btn-danger mt-3">
    🗑️Supprimer
  </a>
{% endif %}
{% endblock %}
